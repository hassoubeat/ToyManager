<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:jsf="http://xmlns.jcp.org/jsf"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
    <head jsf:id="head">
        <meta http-equiv="content-language" content="ja"/>
    </head>
    <body>
        <ui:composition template="/auth/template/template.xhtml">
            <ui:define name="content">
                <f:metadata>
                    <f:viewAction action="#{toyStatusBean.bookmarkable()}" onPostback="false"></f:viewAction>
                </f:metadata>
                <div class="row">
                    <div class="col-xs-3 toy-side-menu">
                        <ui:include src="/auth/template/toyMenu.xhtml"/>
                    </div>
                    <div class="col-xs-9">
                        <div class="well">
                            <h4><span class="glyphicon glyphicon-stats"/> Toy「#{toyStatusBean.targetToy.name}」のステータス</h4>
                            <h4 class="small">Toyの情報を確認します。</h4>
                        </div>
                        
                        <table class="table table-condensed ">
                            <tbody>
                                <tr>
                                    <th>Toyの名前</th>
                                    <td>
                                        #{toyStatusBean.targetToy.name}
<!--                                            <input type="text" id="event-title" jsf:id="toy-title" class="form-control" placeholder="Toyのタイトルを50文字以内で入力してください。" jsf:value="#{toyStatusBean.targetToy.name}"/>
                                        <h:message class="label label-danger" for="toy-title"/>-->
                                    </td>
                                </tr>
                                <tr>
                                    <th>Toyのロットナンバー</th>
                                    <td>#{toyStatusBean.targetToy.rotNum}</td>
                                </tr>

                                <tr>
                                    <th>Toyの同期状況</th>
                                    <td>
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>前回の同期日時</th>
                                                    <!-- TODO 差分イベント同期機能が実装された際に解禁 -->
<!--                                                    <th>同期状態</th>
                                                    <th>前回同期からの差分イベント</th>-->
                                                </tr>
                                            </thead>
                                            <tbody class="text-center">
                                                <tr>
                                                    <td>
                                                        <ui:fragment  rendered="#{toyStatusBean.targetToy.lastSyncDate != null}">
                                                            <!-- 最終同期時刻が存在した場合 -->
                                                            <h:outputText class="label label-default" value="#{item.lastSyncDate}" >
                                                                <f:convertDateTime pattern="yyyy/MM/dd HH:mm"/>
                                                            </h:outputText>
                                                        </ui:fragment>
                                                        <ui:fragment  rendered="#{toyStatusBean.targetToy.lastSyncDate == null}">
                                                            <!-- 最終同期時刻が存在しなかった場合(一度も同期したことがなかった場合) -->
                                                            <label class="label label-default">
                                                                no data
                                                            </label>
                                                        </ui:fragment>
                                                    </td>
                                                    <!-- TODO 差分イベント同期機能が実装された際に解禁 -->
<!--                                                    <td>
                                                        <ui:fragment  rendered="#{toyStatusBean.targetToy.diffSyncEventList.size() == 0}">
                                                            <label class="label label-success">
                                                                 未同期のイベントが存在しない場合 
                                                                sync
                                                            </label>
                                                        </ui:fragment>
                                                        <ui:fragment  rendered="#{toyStatusBean.targetToy.diffSyncEventList.size() > 0}">
                                                            <label class="label label-danger">
                                                                 未同期のイベントが一件以上存在した場合 
                                                                unsync
                                                            </label>
                                                        </ui:fragment>
                                                    </td>
                                                    <td>
                                                        <ui:fragment  rendered="#{toyStatusBean.targetToy.diffSyncEventList.size() == 0}">
                                                             未同期のイベントが存在しない場合 
                                                            <label class="label label-default">
                                                                no data
                                                            </label>
                                                        </ui:fragment>
                                                        <ui:fragment  rendered="#{toyStatusBean.targetToy.diffSyncEventList.size() > 0}">
                                                             未同期のイベントが一件以上存在した場合 
                                                            <a class="label label-info" data-toggle="collapse" data-target="#diff-event-table">
                                                                <span class="glyphicon glyphicon-link"/> #{toyStatusBean.targetToy.diffSyncEventList.size()}件
                                                            </a>
                                                        </ui:fragment>
                                                    </td>-->
                                                </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                                <!-- TODO 差分イベント同期機能が実装された際に解禁 -->
<!--                                <ui:fragment  rendered="#{toyStatusBean.targetToy.diffSyncEventList.size() > 0}">
                                 未同期のイベントが一件以上存在した場合 
                                    <tr>
                                        <th colspan="2" style="border-top-style:none;">
                                            <div id="diff-event-table" class="collapse">
                                                <table class="table table-striped table-bordered">
                                                    <thead>
                                                        <tr>
                                                            <th>イベント種別</th>
                                                            <th>イベント名</th>
                                                            <th>イベント開始日時</th>
                                                            <th>イベント終了日時</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <ui:repeat var="item" value="#{toyStatusBean.targetToy.diffSyncEventList}" varStatus="status">
                                                            <tr>
                                                                <td>
                                                                    <ui:fragment  rendered="#{item.methodType == 'ADD'}">
                                                                         次回同期時追加するイベントだった場合、追加アイコンを表示する 
                                                                        <span class="glyphicon glyphicon-plus"/>
                                                                    </ui:fragment>
                                                                    <ui:fragment  rendered="#{item.methodType == 'UPDATE'}">
                                                                         次回同期時変更するイベントだった場合、変更アイコンを表示する 
                                                                        <span class="glyphicon glyphicon-edit"/>
                                                                    </ui:fragment>
                                                                    <ui:fragment  rendered="#{item.methodType == 'REMOVE'}">
                                                                         次回同期時削除するイベントだった場合、削除アイコンを表示する 
                                                                        <span class="glyphicon glyphicon-minus"/>
                                                                    </ui:fragment>
                                                                    <ui:fragment  rendered="#{item.eventId.accountId != null}">
                                                                         アカウント共有イベントだった場合、共有アイコンを表示する 
                                                                        <span class="glyphicon glyphicon-user"/>
                                                                    </ui:fragment>
                                                                    <ui:fragment  rendered="#{item.eventId.isTalking}">
                                                                         ToyTalk属性イベントだった場合、トーキングアイコンを表示する 
                                                                        <span class="glyphicon glyphicon-volume-up"/>
                                                                    </ui:fragment>
                                                                    <ui:fragment  rendered="#{item.eventId.roop != 0}">
                                                                         繰り返しイベントだった場合、ループアイコンを表示する 
                                                                        <span class="glyphicon glyphicon-repeat"/>
                                                                    </ui:fragment>
                                                                </td>
                                                                <td>#{item.eventId.name}</td>
                                                                <td>
                                                                    <h:outputText value="#{item.eventId.startDate}" >
                                                                        <f:convertDateTime pattern="yyyy/MM/dd HH:mm:ss"/>
                                                                    </h:outputText>
                                                                </td>
                                                                <td>
                                                                    <h:outputText value="#{item.eventId.endDate}" >
                                                                        <f:convertDateTime pattern="yyyy/MM/dd HH:mm:ss"/>
                                                                    </h:outputText>
                                                                </td>
                                                            </tr>
                                                        </ui:repeat>
                                                    </tbody>
                                                </table>
                                                <p/>
                                                <div class="well">
                                                    <h4>ヘルプ</h4>
                                                    <p/>
                                                    <h5>Q.イベント種別の記号の意味は？</h5>
                                                    <h5 class="small"><span class="glyphicon glyphicon-plus"/>...次回同期時にToyTalkに追加されるイベントです。</h5>
                                                    <h5 class="small"><span class="glyphicon glyphicon-edit"/>...既にToyTalkに同期されており、次回同期時にToyTalkに登録内容が修正されるイベントです。</h5>
                                                    <h5 class="small"><span class="glyphicon glyphicon-minus"/>...既にToyTalkに同期されており、次回同期時にToyTalkから削除されるイベントです。</h5>
                                                    <h5 class="small"><span class="glyphicon glyphicon-user"/>...アカウント共有が指定されているイベントです。全てのToyで適応されるイベントです。</h5>
                                                    <h5 class="small"><span class="glyphicon glyphicon-volume-up"/>...ToyTalk属性が指定されたイベントです。ToyTalkにイベントが同期された後、イベントの開始時刻に読み上げを行ってくれます。</h5>
                                                    <h5 class="small"><span class="glyphicon glyphicon-repeat"/>...繰り返しが指定されたイベントです。</h5>
                                                </div>
                                            </div>
                                        </th>
                                    </tr>
                                </ui:fragment>-->
                                <tr>
                                    <th>Toyの音声タイプ</th>
                                    <td>
                                        #{toyStatusBean.targetToy.toyVoiceTypeId.name}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Toyに登録されているファセット</th>
                                    <td>
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>ファセット名</th>
                                                    <th>ファセットの概要</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <ui:repeat var="item" value="#{toyStatusBean.targetToy.toyFacetList}" varStatus="status">
                                                    <tr>
                                                        <td>
                                                            #{item.facetId.name}
                                                        </td>
                                                        <td>
                                                            #{item.facetId.note}
                                                        </td>
                                                    </tr>
                                                </ui:repeat>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                                <tr>
                                    <th>アクセストークン</th>
                                    <td>
                                        <div id="access-token">#{toyStatusBean.targetToy.accessToken}</div>
                                        <p/>
                                        <div class="pull-right">
                                            <button id="clipboard-copy" class="btn-sm btn-info" data-clipboard-target="#access-token" style="margin-right: 5px;"><span class="glyphicon glyphicon-file"/> クリップボードにコピー</button>
                                            <form jsf:id="access-token-regenerate" style="display: inline;">
                                                <button class="btn-sm btn-warning" jsf:id="access-token-regenerate" jsf:action="#{toyStatusBean.accessTokenRegenerate()}" style="margin-right: 5px;"><span class="glyphicon glyphicon-export"/> アクセストークンの再生成</button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th>
                                        アクセストークン有効期限
                                        <!-- アクセストークン有効期限が切れていた場合 -->
                                        <ui:fragment  rendered="#{utilLogicBean.isExistAccessTokenExpired(toyStatusBean.targetToy)}">
                                            <div class="label label-danger">有効期限切れ</div>
                                        </ui:fragment>
                                    </th>
                                    
                                    <td>
                                        <!-- アクセストークン有効期限が切れていた場合 -->
                                        <ui:fragment  rendered="#{utilLogicBean.isExistAccessTokenExpired(toyStatusBean.targetToy)}">
                                            <h:outputText class="label label-danger" value="#{toyStatusBean.targetToy.accessTokenLifecycle}" >
                                                <f:convertDateTime pattern="yyyy/MM/dd HH:mm"/>
                                            </h:outputText>
                                            <u>【アクセストークンの再生成】ボタンを押下して、アクセストークンを再発行してください。</u>
                                        </ui:fragment>
                                        <!-- アクセストークン有効期限が切れていなかった場合 -->
                                        <ui:fragment  rendered="#{!utilLogicBean.isExistAccessTokenExpired(toyStatusBean.targetToy)}">
                                            <h:outputText value="#{toyStatusBean.targetToy.accessTokenLifecycle}" >
                                                <f:convertDateTime pattern="yyyy/MM/dd HH:mm"/>
                                            </h:outputText>
                                        </ui:fragment>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Toyアプリケーションバージョン</th>
                                    <td>
                                        ver #{toyStatusBean.targetToy.toyVersionId.version}
                                    </td>
                                </tr>
                                <tr>
                                    <th>アクセスフィルター</th>
                                    <td>
                                        
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Macアドレスハッシュ</th>
                                                    <th>状態</th>
                                                    <th>アクション</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <ui:repeat var="item" value="#{toyStatusBean.targetToy.toyWebapiAccessFilterList}" varStatus="status">
                                                    <tr>
                                                        <td>
                                                            #{item.macAddress}
                                                        </td>
                                                        <td>
                                                            <!-- 未認証の場合 -->
                                                            <ui:fragment  rendered="#{!item.isAuthenticated}">
                                                                <h4><span class="label label-warning"><span class="glyphicon glyphicon-unchecked"/> 認証待ち</span></h4>
                                                            </ui:fragment>
                                                            <!-- 認証済の場合 -->
                                                            <ui:fragment  rendered="#{item.isAuthenticated}">
                                                                <h4><span class="label label-success"><span class="glyphicon glyphicon-check"/> 認証済み</span></h4>
                                                            </ui:fragment>
                                                            
                                                        </td>
                                                        <td>
                                                            <form jsf:id="web-api-access-filter-form">
                                                                <!-- 未認証の場合 -->
                                                                <ui:fragment  rendered="#{!item.isAuthenticated}">
                                                                    <button class="btn-sm btn-success" jsf:id="web-api-access-filter-approval" jsf:action="#{toyStatusBean.webApiAccessFilterApproval(item)}" style="margin-right: 5px;">承認</button>
                                                                    <button class="btn-sm btn-danger" jsf:id="web-api-access-filter-reject1" jsf:action="#{toyStatusBean.webApiAccessFilterReject(item)}" style="margin-right: 5px;">拒否</button>
                                                                </ui:fragment>
                                                                <!-- 認証済の場合 -->
                                                                <ui:fragment  rendered="#{item.isAuthenticated}">
                                                                    <button class="btn-sm btn-danger" jsf:id="web-api-access-filter-reject2" jsf:action="#{toyStatusBean.webApiAccessFilterReject(item)}" style="margin-right: 5px;">拒否</button>
                                                                </ui:fragment>
                                                            </form>
                                                        </td>
                                                    </tr>
                                                </ui:repeat>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="btn btn-danger" id="toy-account-tying-cancel-modal-switch" data-toggle="modal" href="#toy-account-tying-cancel-modal">Toyの紐付け解除</div>
                        
                        
                    </div>
<!--                    <div class="modal fade" id="last-time-sync-diff-modal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal"><span>×</span></button>
                                    <h4 class="modal-title" >前回同期の差分</h4>
                                </div>
                                <div class="modal-body">
                                    <h5 class="alert alert-warning">次回同期のタイミングで以下のイベントがToyに同期されます</h5>
                                    
                                    
                                    
                                    <div class="panel panel-primary">
                                        <div class="panel-heading">
                                            <b><span class="glyphicon glyphicon-plus"/> 追加： <u>MyJスマホスケジュール会議</u></b>
                                        </div>
                                        <div class="panel-body">
                                            <div class="well">
                                                <p><b><u>Toyの読み上げ</u></b></p>
                                                会議室FでMyJスマホのスケジュール会議
                                            </div>
                                            <b>日時:</b> <label class="label label-default">2017-01-09 13:30:00</label> 〜<label class="label label-default">2017-01-09 15:00:00</label> <br/>
                                            <b>繰り返し:</b> <label class="label label-default">2017-04-01 00:00:00</label>まで
                                            <div class="text-center">
                                                <table class="table">
                                                    <thead>
                                                        <td>年</td><td>月</td><td class="fc-sun">日</td><td>月</td><td>火</td><td>水</td><td>木</td><td>金</td><td class="fc-sat">土</td>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>-</td><td>-</td><td>-</td><td>◯</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
                                                        </tr>
                                                        <tr>
                                                            <td>-</td><td>-</td><td>-</td><td><label class="label label-info">13:30</label></td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="panel panel-success">
                                        <div class="panel-heading">
                                            <b><span class="glyphicon glyphicon-edit"/> 編集： <u>MyJスマホスケジュール会議</u></b>
                                        </div>
                                        <div class="panel-body">
                                            <div class="well">
                                                <p><b><u>Toyの読み上げ</u></b></p>
                                                会議室FでMyJスマホのスケジュール会議
                                            </div>
                                            <b>日時:</b> <label class="label label-default">2017-01-09 13:30:00</label> 〜<label class="label label-default">2017-01-09 15:00:00</label> <br/>
                                            <b>繰り返し:</b> <label class="label label-default">2017-04-01 00:00:00</label>まで
                                            <div class="text-center">
                                                <table class="table">
                                                    <thead>
                                                        <td>年</td><td>月</td><td class="fc-sun">日</td><td>月</td><td>火</td><td>水</td><td>木</td><td>金</td><td class="fc-sat">土</td>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>-</td><td>-</td><td>-</td><td>◯</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
                                                        </tr>
                                                        <tr>
                                                            <td>-</td><td>-</td><td>-</td><td><label class="label label-info">13:30</label></td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="panel panel-danger">
                                        <div class="panel-heading">
                                            <b><span class="glyphicon glyphicon-minus"/> 削除： <u>MyJスマホスケジュール会議</u></b>
                                        </div>
                                        <div class="panel-body">
                                            <div class="well">
                                                <p><b><u>Toyの読み上げ</u></b></p>
                                                会議室FでMyJスマホのスケジュール会議
                                            </div>
                                            <b>日時:</b> <label class="label label-default">2017-01-09 13:30:00</label> 〜<label class="label label-default">2017-01-09 15:00:00</label> <br/>
                                            <b>繰り返し:</b> <label class="label label-default">2017-04-01 00:00:00</label>まで
                                            <div class="text-center">
                                                <table class="table">
                                                    <thead>
                                                        <td>年</td><td>月</td><td class="fc-sun">日</td><td>月</td><td>火</td><td>水</td><td>木</td><td>金</td><td class="fc-sat">土</td>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>-</td><td>-</td><td>-</td><td>◯</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
                                                        </tr>
                                                        <tr>
                                                            <td>-</td><td>-</td><td>-</td><td><label class="label label-info">13:30</label></td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>   
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-default" data-dismiss="modal">閉じる</button>
                                </div>
                            </div>
                        </div>
                   </div>-->
                </div>
                <!-- Toy紐付け解除前の警告モーダルダイアログ -->
                <div class="modal fade" id="toy-account-tying-cancel-modal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal"><span>×</span></button>
                                <h4 class="modal-title">Toy「#{toyStatusBean.targetToy.name}」のアカウント紐付けを解除しますか？</h4>
                            </div>
                            <div class="modal-body">
                                <div class="bs-callout bs-callout-danger">
                                    <h4>アカウント紐付けを解除した場合、以下の処理が実行されます。</h4>
                                    <h5 class="small">・Toyに登録したイベントの削除(アカウント共有イベントは削除対象外です。)</h5>
                                </div>
                                <form jsf:id="toy-account-tying-cancel-form">
                                    <button class="btn btn-danger" jsf:id="toy-account-tying-cancel" jsf:action="#{toyStatusBean.accountTyingCancel()}" style="margin-right: 5px;">Toyの紐付け解除</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Toy未選択時の通知モーダルダイアログ -->
                <div class="modal fade" id="not-selected-toy-modal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal"><span>×</span></button>
                                <h4 class="modal-title">Toyが未選択です。</h4>
                            </div>
                            <div class="modal-body">
                                <div class="bs-callout bs-callout-warning">
                                    <h4>画面右のToy一覧からToyを選択してください。</h4>
                                    <h5 class="small">・ステータスを参照するToyが未選択です。</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </ui:define>
            <ui:define name="css">
                <!-- jQueryToaster CSS -->
                <link jsf:library="css" jsf:name="jquery.toast.css"/>
            </ui:define>
            <ui:define name="js">
                <!-- jQueryToaster JS -->
                <script jsf:library="js" jsf:name="jquery.toast.js"/>
                <!-- Clipboard JS -->
                <script jsf:library="js" jsf:name="clipboard.js"/>
                <script type="text/javascript">
                    $(window).load(function () {
                        // ナビゲーションバーのactiveを変更
                        $("#toy").addClass("active");
                        
                        // Toy選択済チェック
                        if(#{sessionBean.selectedToyId} === 0) {
                            // Toyが未選択だった場合、選択を促すダイアログを表示する
                            $("#not-selected-toy-modal").modal();
                        }
                        
                        $("#toy-account-tying-cancel-modal-switch").click(function() {
                            if(#{sessionBean.selectedToyId} === 0) {
                                // Toyが未選択だった場合、選択を促すダイアログを表示する
                                $("#not-selected-toy-modal").modal();
                                return false;
                            }
                        });
                        
                        // クリップボードにコピーボタンの設定
                        var clipboard = new Clipboard('#clipboard-copy');
                        clipboard.on('success', function(e) {
                            // コピー成功時
                            e.clearSelection();
                            $.toast({
                                heading: "コピーしました。",
                                showHideTransition: "slide",
                                icon: "info",
                                position: "bottom-right",
                                stack: "1"
                            });
                        });
                        clipboard.on('error', function(e) {
                            // コピー失敗時
                            $.toast({
                                heading: "コピーに失敗しました。",
                                showHideTransition: "slide",
                                icon: "info",
                                position: "bottom-right",
                                stack: "1"
                            });    
                        });
                        
                        
                    });
                </script>
            </ui:define>
        </ui:composition>        
    </body>
</html>

